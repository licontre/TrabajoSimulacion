<html>
  <head>
    <title>TrabajoSimulacion</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load("current", {packages:["corechart"]});
      google.charts.setOnLoadCallback(drawChart);
      //Variables Grafico
      var options_stacked = { isStacked: true, height: 300, legend: {position: 'top', maxLines: 3}, vAxis: {minValue: 0}};
      var options_histograma = {  title: 'Aplicacion Teorema Central del Limite',
                                  legend: { position: 'top' },
                                  colors: ['orange','blue'],
                                  chartArea: { width: 801 },
                                  axisTitlesPosition:'in',
                                  bar: { gap: 0.02 },
                                  histogram: {
                                    bucketSize: 1,
                                    maxNumBuckets: 300
                                  },
                                  animation:{ startup:'true'}
                                };
      var options_histograma2 = { title: 'Distribucion de Frecuencias',
                                  legend: { position: 'top' },
                                  colors: ['green'],
                                  chartArea: { width: 801 },
                                  axisTitlesPosition:'in',
                                  bar: { gap: 0.02 },
                                  histogram: {
                                                bucketSize: 1,
                                                maxNumBuckets: 300
                                              }
                                };
      var chart ;
      var chart2 ;
      var data;
      var data2;
      //Arrays de valores calculados
      var listaValores;
      var listaNormal;
      var distribucionElegida;
      var frecuenciasRelativas;
      var frecuenciasAbsolutas;
      var probabilidadTeorica;
      var valores;
      var ytcl;
      var media = 0;
      var varianza = 1;
      var miN = 100;
      function sortNumber(a,b) {
          return a - b;
      };

      function fact(x)
      {
        if (x == 0)
        {
          return 1;
        }
          return x * fact(x-1);
      };

      function trunc (x, posiciones = 0) {
        var s = x.toString()
        var l = s.length
        var decimalLength = s.indexOf('.') + 1
        var numStr = s.substr(0, decimalLength + posiciones)
        return Number(numStr);
      };

      function generarGraficas (){
        chart = new google.visualization.Histogram(document.getElementById('chart_div'));
        chart2 = new google.visualization.Histogram(document.getElementById('chart_div_2'));
      };

      function aplicarTCL( x ){
        return ( x - media )/Math.sqrt(varianza);
      };

      function probBinomial(n,p,x){
        var b1 = fact(n)/(fact(x)*fact(n-x));
        var b2 = Math.pow(p,x);
        var b3 = Math.pow(1-p,n-x);
        return b1*b2*b3;
      };

      function probPoisson(k,l){
        var p1 = Math.pow(Math.E,-l);
        var p2 = Math.pow(l,k);
        var p3 = fact(k);
        return p1*p2/p3;
      };

      function generarValorBinomial( n,  p){
        var i = 0;
        var res = 0;
        for( i=0;i < parseInt(n);i++ ){
          if(Math.random() < parseFloat(p)){
            res++;
          }
        }
        return res;
      };

      function generarValorPoisson(l){
          var res = 0;
          var i = 0;
          while(  res < l ){
            res += -Math.log(Math.random());
            i++;
          }
          return i;
      };
      function generarMediaVarianza(){
        media = 0;
        varianza = 0;
        for(i = 0; i<distribucionElegida.length;i++){
          media = media + distribucionElegida[i];
        }
        media = media / distribucionElegida.length;
        for(i = 0; i<distribucionElegida.length;i++){
          varianza = varianza + Math.pow(distribucionElegida[i] - media,2);
        }
        varianza = varianza / ( distribucionElegida.length - 1 );
      };

      function generarValores(n,p,m){
        var lista = [];
        var distribucion = document.getElementById("distribuciones");
        var i = 0;
        for(i = 0;i<m;i++){
          lista.push(generaValorNormal(0,1));
        }
        listaNormal = lista.sort(sortNumber);
        lista = [];
        listaValores = [];
        i = 0;
        if( distribucion != null && distribucion.value == " Distribucion Binomial " ){
          for(i = 0;i<m;i++){
            lista.push(generarValorBinomial(n,p));
          }
          listaValores.push(["X","Binomial","Normal"]);
        }else{
          for(i = 0;i<m;i++){
            lista.push(generarValorPoisson(p));
          }
          listaValores.push(["X","Poisson","Normal"]);
        }
        distribucionElegida = lista.sort(sortNumber);
        i = 0;
        var res = "";
        for(i = 0;i<m;i++){
          listaValores.push([i,distribucionElegida[i],listaNormal[i]]);
        }
        generarMediaVarianza();
      };

      function generaValorNormal(mu,sig){
        var t = 0;
        var i = 0;
        for(i=0;i<12;i++)
        {
          t += Math.random();
        }
        t = t -6;
        t = t*sig + mu;
        return t;
      };
      function insertarFilaValoresTabla(row,obj){
        var celda1 = row.insertCell(0);
        var celda2 = row.insertCell(1);
        var celda3 = row.insertCell(2);
        var celda4 = row.insertCell(3);
        celda1.innerHTML = trunc(obj[0],3);
        celda2.innerHTML = trunc(obj[1],3);
        celda3.innerHTML = trunc(obj[2],3);
        celda4.innerHTML = trunc(aplicarTCL(parseInt(obj[1])),3);
      };

      /*
        Pone el array de valores en la primera tabla id="tabla"
      */
      function ponerValoresTabla(){
        var i = 1;
        var tabla = document.getElementById("tabla");
        tabla.insertRow(0).innerHTML ="<thead><tr><th>"+listaValores[0][0]+"</th><th>"+listaValores[0][1]+"</th><th>"+listaValores[0][2]+"</th><th>Ytcl( "+listaValores[0][1]+" )</th></tr></thead>";
        for ( i=1 ; i < listaValores.length ; i++){
           insertarFilaValoresTabla(tabla.insertRow(i),listaValores[i]);
        }
      };

      function generarFrecuencias(p){
        var i = 1;
        var cont = 1;
        frecuenciasRelativas = [];
        frecuenciasAbsolutas = [];
        probabilidadTeorica = [];
        valores = [];
        var actual = distribucionElegida[0];
        for(i = 1 ; i< distribucionElegida.length;i++){
          if(actual != distribucionElegida[i]){
            valores.push(actual);
            frecuenciasAbsolutas.push(cont);
            frecuenciasRelativas.push(cont/distribucionElegida.length);
            if(document.getElementById("distribuciones").value ==  " Distribucion Binomial " ){
                probabilidadTeorica.push(probBinomial(miN,parseFloat(p),actual));
            }else{
              probabilidadTeorica.push(probPoisson(actual,parseFloat(p)));
            }
            actual = distribucionElegida[i];
            cont = 1;
          }else{
            cont++;
          }
        }
        valores.push(actual);
        frecuenciasAbsolutas.push(cont);
        frecuenciasRelativas.push(cont/distribucionElegida.length);
        if(document.getElementById("distribuciones").value ==  " Distribucion Binomial " ){
            var n = parseInt(document.getElementById("ene").value);
          probabilidadTeorica.push(probBinomial(n,parseFloat(p),actual));
        }else{
          probabilidadTeorica.push(probPoisson(actual,parseFloat(p)));
        }
      };

      function ponerFilaFrecuencias(fila,i){
        fila.insertCell(0).innerHTML = valores[i];
        fila.insertCell(1).innerHTML = frecuenciasAbsolutas[i];
        fila.insertCell(2).innerHTML = frecuenciasRelativas[i];
        fila.insertCell(3).innerHTML = trunc(probabilidadTeorica[i],3);
      };

      function ponerFrecuencias(){
        var tabla = document.getElementById("tablaFrecuencias");
        var row = tabla.insertRow(0).innerHTML ="<thead><tr><th>  Xi  </th><th>  fi  </th><th>  hi  </th><th>  Pt  </th></tr></thead>";
        var i = 0;
        for(i = 1 ;i<= valores.length;i++){
          ponerFilaFrecuencias(tabla.insertRow(i),i-1);
        }
      };
      function generarYTCLvsNormal(){
          var lista = [];
          var i = 0;
          ytcl=[];
          lista.push(["Normal","Ytcl"]);
          for(i=0;i<listaNormal.length;i++){
            ytcl.push(aplicarTCL(distribucionElegida[i]));
            lista.push([listaNormal[i],aplicarTCL(distribucionElegida[i])]);
          }
          return lista;
      };

      function generarDistribucionFrecuencias(){
          var i = 0;
          var lista = [];
          for (i = 0; i< listaValores.length;i++)
          {
            lista.push([listaValores[i][1]]);
          }
          return lista;
        };

        function ponerMediaVarianzaYTCL(){
          var media2 = 0;
          var varianza2 = 0;
          for(i = 0; i<ytcl.length;i++){
            media2 = media2 + ytcl[i];
          }
          media2 = media2 / ytcl.length;
          for(i = 0; i<ytcl.length;i++){
            varianza2 = varianza2 + Math.pow(ytcl[i] - media2,2);
          }
          varianza2 = varianza2 / ( ytcl.length - 1 );
          document.getElementById("mediay").innerHTML=" media_ytcl =  " + media2;
          document.getElementById("varianzay").innerHTML=" S2_ytcl =  " +varianza2;
        };

        function drawChart() {
          ponerNyP(100,0.4);
          borrarTablas();
          generarGraficas();//GRaficas Inicializa
          generarValores(parseInt(100),parseFloat(0.4),1000);
          ponerValoresTabla();
          generarFrecuencias(0.4);
          ponerFrecuencias();
          ponerMediaVarianza();
          data = new google.visualization.arrayToDataTable(generarYTCLvsNormal());
          data2 = new google.visualization.arrayToDataTable(generarDistribucionFrecuencias());
          ponerMediaVarianzaYTCL();
          chart.draw(data , options_histograma);
          chart2.draw(data2 , options_histograma2);
          return false;
        };

        function nuevoCaso(){
          borrarTablas();
          chart.clearChart();
          chart2.clearChart();
          var n = parseInt(document.getElementById("ene").value);
          var p = parseFloat(document.getElementById("prob").value);
          miN = parseInt(n);
          generarValores(n,p,1000);
          ponerValoresTabla();
          generarFrecuencias(p);
          ponerFrecuencias();
          ponerMediaVarianza();
          data = new google.visualization.arrayToDataTable(generarYTCLvsNormal());
          data2 = new google.visualization.arrayToDataTable(generarDistribucionFrecuencias());
          ponerMediaVarianzaYTCL();
          chart.draw(data , options_histograma);
          chart2.draw(data2 , options_histograma2);
          return false;
        };

        function ponerMediaVarianza(){
          document.getElementById("media").innerHTML = " media =  " + media;
          document.getElementById("varianza").innerHTML = " S2 = " + trunc(varianza,4);
        };

        function borrarTablas()
        {
          document.getElementById("tabla").innerHTML= "";
          document.getElementById("tablaFrecuencias").innerHTML= "";
          document.getElementById("probIntt").innerHTML = "";
          document.getElementById("probInt").innerHTML = "";
          document.getElementById("varianza").innerHTML = "";
          document.getElementById("media").innerHTML = "";
          document.getElementById("error").innerHTML = "";
          document.getElementById("varianzay").innerHTML = "";
          document.getElementById("mediay").innerHTML = "";
          listaValores = null;
          listaNormal = null;
          distribucionElegida = null;
          frecuenciasRelativas = null;
          frecuenciasAbsolutas = null;
          probabilidadTeorica = null;
          ytcl = null;
          valores= null;
        };
        function ponerNyP(n,p){
          document.getElementById("ene").value = n;
          document.getElementById("prob").value = p;
        };
        function hideLlanda()
        {
          var distribucion = document.getElementById("distribuciones");
          if(distribucion != null && distribucion.value == " Distribucion Binomial "  )
          {
            document.getElementById("ene").style.display = "block";
            document.getElementById("labelene").style.display = "block";
            document.getElementById("etqP").innerHTML = 'p=';
          }else if ( distribucion != null ){
            document.getElementById("ene").style.display = "none";
            document.getElementById("labelene").style.display = "none";
            document.getElementById("etqP").innerHTML = 'l=';
          }
        };



        function generarIntervalo()
        {
          var a = document.getElementById("a").value;
          var b = document.getElementById("b").value;
          var i = 0;
          var pt = 0;
          var ph = 0;
          while ( i < valores.length && a != valores[i] )
          {
            i++;
          }
          var j = i.valueOf();
          while( j < valores.length && b !=  valores[j] )
          {
            j++;
          }
          if(j == valores.length || i == valores.length){
            return false;
          }
          if( document.getElementById("intervalos").value == "(a,b)" )
          {
              var k = i+1;
              for( k = i+1; k<j; k++)
              {
                ph = ph + frecuenciasRelativas[k] ;
                pt = pt + probabilidadTeorica[k];
              }
              document.getElementById("probInt").innerHTML ='P( (a,b) )=' + trunc(ph,4).toString();
              document.getElementById("probIntt").innerHTML ='Pt( (a,b) )='+trunc(pt,4).toString();
              document.getElementById("error").innerHTML ='Error( (a,b) )='+trunc(Math.abs(pt-ph),4);
          }else if (document.getElementById("intervalos").value == "[a,b)"){
            var k = i;
            for( k = i; k<j; k++)
            {
              ph = ph + frecuenciasRelativas[k] ;
              pt = pt + probabilidadTeorica[k];
            }
            document.getElementById("probInt").innerHTML ='P( [a,b) )=' + trunc(ph,4).toString();
            document.getElementById("probIntt").innerHTML ='Pt( [a,b) )='+trunc(pt,4).toString();
            document.getElementById("error").innerHTML ='Error( [a,b) )='+trunc(Math.abs(pt-ph),4);
          }else if (document.getElementById("intervalos").value == "(a,b]"){
            var k = i+1;
            for( k = i+1; k<j+1; k++)
            {
              ph = ph + frecuenciasRelativas[k] ;
              pt = pt + probabilidadTeorica[k];
            }
            document.getElementById("probInt").innerHTML ='P( (a,b] )=' + trunc(ph,4).toString();
            document.getElementById("probIntt").innerHTML ='Pt( (a,b] )='+trunc(pt,4).toString();
            document.getElementById("error").innerHTML ='Error( (a,b] )='+trunc(Math.abs(pt-ph),4);
          }else{
            var k = i;
            for( k = i; k<j+1; k++)
            {
              ph = ph + frecuenciasRelativas[k] ;
              pt = pt + probabilidadTeorica[k];
            }
            document.getElementById("probInt").innerHTML ='P( [a,b] )=' + trunc(ph,4).toString();
            document.getElementById("probIntt").innerHTML ='Pt( [a,b] )='+trunc(pt,4).toString();
            document.getElementById("error").innerHTML ='Error( [a,b] )='+trunc(Math.abs(pt-ph),4);
          }
          return false;
        };






    </script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  </head>
  <body>
    <h1 style="text-align:center;">Trabajo de Simulación.</h1>
    <div class="input-group" style="justify-content: center;">
          <select id="distribuciones" class="custom-select col-2" onchange="hideLlanda()">
            <option name="Binomial" value=" Distribucion Binomial "> Distribucion Binomial </option>
            <option name="Poisson" value=" Distribucion de Poisson "> Distribucion de Poisson </option>
          </select>
          <label id="labelene" style="margin:5px;" > n= </label ><input type="text" class="form-control col-1" aria-label="Small" aria-describedby="inputGroup-sizing-sm"  id="ene"></input>
          <label style="margin:5px;" id="etqP"> p= </label><input type="text" class="form-control col-1" aria-label="Small" aria-describedby="inputGroup-sizing-sm"  id="prob" ></input>
          <input type="button" class="btn btn-success" value="Generar" style="margin-left:7px;" onclick="nuevoCaso()"></input>
    </div>
    <div id="chart_div_2" style="width: 900px; height: 500px;display: block;margin: 0 auto;"></div>
    <div class="input-group" style="justify-content: center;">
      <select id="intervalos" class="custom-select col-1" onchange="">
        <option name="(a,b)" value="(a,b)">(a,b)</option>
        <option name="[a,b)" value="[a,b)">[a,b)</option>
        <option name="(a,b]" value="(a,b]">(a,b]</option>
        <option name="[a,b]" value="[a,b]">[a,b]</option>
      </select>
      <input type="text" class="form-control col-1" aria-label="Small" aria-describedby="inputGroup-sizing-sm" id="a"  value="a"></input>
      <input type="text" class="form-control col-1" aria-label="Small" style="margin-left:7px;" aria-describedby="inputGroup-sizing-sm" id="b"  value="b"></input>
      <input type="button" class="btn btn-info" value="calcular" style="margin-left:7px;" onClick="generarIntervalo()"></input>
    </div>
    <br/>
<div style="justify-content: center;">
<table align="center" >
  <tr>
    <td valign="top">
      <div style="overflow:scroll;height:350px;">
        <table class="table-bordered" id="tabla" cellpadding="5">
          <thead>
            <tr>
            <th>X</th>
            <th>Binomial</th>
            <th>Normal</th>
            <th>TCL( Binomial )</th>
          </tr>
          </thead>
        </table>
      </div>
    </td>
    <td valign="top">
      <div style="overflow:scroll;height:350px;">
        <table class="table-bordered" id="tablaFrecuencias" cellpadding="5">
          <thead><tr><th>  Xi  </th><th>  fi  </th><th>  hi  </th><th>  Pt  </th></tr></thead>
        </table>
      </div>
    </td>
    <td valign="top">
      <label style="margin-left:15px;" id="mediay"></label><br/><br/>
      <label style="margin-left:15px;" id="varianzay"></label><br/><br/>
      <label style="margin-left:15px;" id="media"></label><br/><br/>
      <label style="margin-left:15px;" id="varianza"></label><br/><br/>
      <label style="margin-left:15px;" id="probInt"></label><br/><br/>
      <label style="margin-left:15px;" id="probIntt"></label><br/><br/>
      <label style="margin-left:15px;" id="error"></label>
    </td>
  </tr>
</table>
</div>
<div id="chart_div" style="width: 900px; height: 500px;margin-left:50px;display: block;margin: 0 auto;"></div>
<p id="parrafo"></p>
  </body>
    <div id="footer">
    <div class="container">
      <p class="text-muted credit"><a href="https://github.com/licontre/TrabajoSimulacion">José María Carralero Martín.</a></p>
    </div>
  </div>
</html>
